<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Expense List | ExpenseTracker</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body class="dashboard-body">

<div class="dashboard-wrapper">

    <!-- SIDEBAR -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- MAIN CONTENT -->
    <main class="main-content">

        <!-- TOP BAR -->
        <div class="topbar">
            <div class="d-flex align-items-center gap-3">
                <!-- ☰ MOBILE SIDEBAR TOGGLE -->
                <button class="btn btn-light d-lg-none" id="sidebarToggle">
                    <i class="bi bi-list"></i>
                </button>

                <h4 class="mb-0">Expense List</h4>
            </div>

            <div class="user-info">
                <i class="bi bi-person-circle"></i>

                <!-- ✅ CHANGED HERE -->
                <span th:text="${user.name}">User</span>
            </div>
        </div>


        <!-- SUCCESS TOAST -->
        <div th:if="${successMessage}" class="toast-success">
            <div class="toast-icon">
                <i class="bi bi-check-lg"></i>
            </div>
            <div class="toast-content">
                <strong>Success</strong>
                <span th:text="${successMessage}"></span>
            </div>
        </div>

        <!-- EXPENSE LIST -->
        <div class="expense-list-card">

            <div class="d-flex justify-content-between mb-3">
                <h5>Your Expenses</h5>
                <a th:href="@{/expenses/add}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> Add Expense
                </a>
            </div>

            <form method="get"
                  th:action="@{/expenses/list}"
                  class="row g-2 mb-3">

                <div class="col-md-3">
                    <select name="categoryId"
                            class="form-select"
                            onchange="this.form.submit()">
                        <option value="">All Categories</option>
                        <option th:each="c : ${categories}"
                                th:value="${c.id}"
                                th:text="${c.name}">
                        </option>
                    </select>
                </div>

                <div class="col-md-3">
                    <input type="date" name="fromDate" class="form-control">
                </div>

                <div class="col-md-3">
                    <input type="date" name="toDate" class="form-control">
                </div>

                <div class="col-md-3">
                    <button class="btn btn-primary ">
                        Filter
                    </button>
                    <!-- ✅ RESET BUTTON -->
                    <a th:href="@{/expenses/list}" class="btn btn-danger ">
                        Reset
                    </a>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table expense-table align-middle">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th class="text-end">Amount</th>
                        <th class="text-end">Actions</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="expense, iter : ${expenses}">
                        <td th:text="${iter.count}"></td>
                        <td th:text="${expense.title}"></td>

                        <!-- ✅ CATEGORY NAME -->
                        <td th:text="${expense.category.name}"></td>

                        <td th:text="${#strings.abbreviate(expense.description, 40)}"></td>
                        <td th:text="${expense.date}"></td>
                        <td class="text-end">₹ <span th:text="${expense.amount}"></span></td>

                        <td class="text-end">
                            <button class="btn btn-outline-primary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editExpenseModal"
                                    th:data-id="${expense.id}"
                                    th:data-title="${expense.title}"
                                    th:data-category-id="${expense.category.id}"
                                    th:data-date="${expense.date}"
                                    th:data-amount="${expense.amount}"
                                    th:data-description="${expense.description}">
                                <i class="bi bi-pencil"></i>
                            </button>

                            <a th:href="@{/expenses/delete/{id}(id=${expense.id})}"
                               class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('Delete this expense?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(expenses)}">
                        <td colspan="7" class="text-center text-muted py-4">
                            No expenses found
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>


            <nav>
                <ul class="pagination justify-content-end">

                    <li class="page-item"
                        th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/expenses/list(page=${currentPage != null ? currentPage - 1 : 0})}">
                            Previous
                        </a>
                    </li>

                    <li class="page-item"
                        th:each="i : ${#numbers.sequence(0, totalPages-1)}"
                        th:classappend="${i == currentPage} ? 'active'">
                        <a class="page-link"
                           th:text="${i + 1}"
                           th:href="@{/expenses/list(page=${i})}">
                        </a>
                    </li>

                    <li class="page-item"
                        th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/expenses/list(page=${currentPage != null ? currentPage + 1 : 0})}">
                            Next
                        </a>
                    </li>

                </ul>
            </nav>
        </div>
    </main>
</div>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="editExpenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <!-- ✅ HEADER -->
            <div class="modal-header">
                <h5 class="modal-title">Edit Expense</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <form method="post"
                  th:action="@{/expenses/update}"
                  th:object="${editExpense}">

                <!-- ✅ BODY -->
                <div class="modal-body row g-3">

                    <input type="hidden" th:field="*{id}" id="edit-id"/>

                    <!-- TITLE -->
                    <div class="col-md-6">
                        <label class="form-label">Title</label>
                        <input class="form-control" th:field="*{title}">
                        <small class="text-danger" th:errors="*{title}"></small>
                    </div>

                    <!-- AMOUNT -->
                    <div class="col-md-6">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01"
                               class="form-control"
                               th:field="*{amount}">
                        <small class="text-danger" th:errors="*{amount}"></small>
                    </div>

                    <!-- CATEGORY -->
                    <div class="col-md-6">
                        <label class="form-label">Category</label>

                        <select class="form-select"
                                th:field="*{category.id}"
                                id="edit-category"
                                required>

                            <option value="">Select Category</option>

                            <option th:each="cat : ${categories}"
                                    th:value="${cat.id}"
                                    th:text="${cat.name}">
                            </option>

                        </select>

                        <small class="text-danger" th:errors="*{category}"></small>
                    </div>

                    <!-- DATE -->
                    <div class="col-md-6">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" th:field="*{date}">
                    </div>

                    <!-- DESCRIPTION -->
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea class="form-control"
                                  rows="3"
                                  th:field="*{description}"></textarea>
                    </div>

                </div>

                <!-- ✅ FOOTER -->
                <div class="modal-footer">
                    <button class="btn btn-primary">Update</button>
                    <button type="button"
                            class="btn btn-outline-danger"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Sidebar -->
<script th:src="@{/js/slidebar.js}"></script>

<script>
    const editModal = document.getElementById('editExpenseModal');

    editModal.addEventListener('show.bs.modal', function (event) {
        const b = event.relatedTarget;

        // ID
        document.getElementById('edit-id').value = b.dataset.id || '';

        // Title
        document.querySelector('[name="title"]').value =
            b.dataset.title || '';

        // Amount
        document.querySelector('[name="amount"]').value =
            b.dataset.amount || '';

        // Description
        document.querySelector('[name="description"]').value =
            b.dataset.description || '';

        // Category
        document.getElementById('edit-category').value =
            b.dataset.categoryId || '';

        // ✅ DATE (SAFE FIX)
        const dateInput = document.querySelector('[name="date"]');
        if (b.dataset.date) {
            dateInput.value = b.dataset.date;
        } else {
            dateInput.value = '';
        }
    });
</script>

<!-- AUTO OPEN MODAL ON ERROR -->
<script th:if="${openEditModal}">
    new bootstrap.Modal(
        document.getElementById('editExpenseModal')
    ).show();
</script>

</body>
</html>
